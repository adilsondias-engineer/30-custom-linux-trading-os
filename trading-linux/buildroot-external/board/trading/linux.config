# === CPU ===
CONFIG_SMP=y
CONFIG_NR_CPUS=32
CONFIG_X86_INTEL_PSTATE=y
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
# PREEMPT_DYNAMIC allows runtime switching between PREEMPT modes
# This matches your working PC kernel (Ubuntu uses PREEMPT_DYNAMIC)
# Available in kernel 5.13+, allows switching between PREEMPT_NONE, PREEMPT_VOLUNTARY, and PREEMPT at boot
# Use kernel parameter: preempt=none, preempt=voluntary, or preempt=full (default is full)
# This is more compatible with NVIDIA drivers than static CONFIG_PREEMPT
CONFIG_PREEMPT_DYNAMIC=y
CONFIG_HZ_1000=y  # 1ms timer resolution
# Disable clocksource watchdog to prevent hangs/delays
CONFIG_CLOCKSOURCE_WATCHDOG=n
CONFIG_CLOCKSOURCE_VALIDATE_LAST_CYCLE=n
# Enable full dynamic tickless (nohz_full) support
# CONFIG_NO_HZ is the base option, CONFIG_NO_HZ_FULL requires it
CONFIG_NO_HZ=y
CONFIG_NO_HZ_FULL=y
CONFIG_TICK_CPU_ACCOUNTING=y
# === Memory ===
CONFIG_TRANSPARENT_HUGEPAGE=y
CONFIG_HUGETLBFS=y
CONFIG_MEMORY_ISOLATION=y
CONFIG_EXT2_FS_SECURITY=y
CONFIG_EXT2_FS_XATTR=y
# === PCIe / DMA ===
CONFIG_PCI=y
CONFIG_PCIEPORTBUS=y
CONFIG_PCI_MSI=y
CONFIG_HOTPLUG_PCI_PCIE=y  # Not needed
CONFIG_DMA_ENGINE=y
CONFIG_DMADEVICES=y
CONFIG_INTEL_IOATDMA=n  # Not using IOAT

# === VFIO (Virtual Function I/O) for DPDK kernel bypass ===
# VFIO allows safe direct access to PCI devices from userspace (required by DPDK)
# DPDK uses vfio-pci module to bind network interfaces for kernel bypass
CONFIG_VFIO=y                    # VFIO core framework
CONFIG_VFIO_IOMMU_TYPE1=y        # IOMMU type 1 support (required for Intel IOMMU)
CONFIG_VFIO_PCI=m                # VFIO PCI driver (module - required for DPDK, load with: modprobe vfio-pci)
CONFIG_VFIO_PCI_VGA=n            # VGA passthrough (not needed)
CONFIG_VFIO_PCI_MMAP=y           # Enable MMAP support for VFIO-PCI devices
CONFIG_VFIO_PCI_INTX=y           # Enable INTx interrupt support
CONFIG_VFIO_MDEV=y               # Mediated device support (optional, but useful)

# === NVIDIA GPU ===
# Built as external module (NVIDIA proprietary driver)
# IMPORTANT: Ensure kernel is recognized as vanilla (not vendor-patched)
# NVIDIA driver installer checks for vendor-specific kernel strings
CONFIG_DRM=y
CONFIG_DRM_KMS_HELPER=y          # KMS helper functions (required for DRM/KMS)
CONFIG_DRM_GEM_SHMEM_HELPER=y    # GEM shmem helper (required for DRM)
CONFIG_DRM_LEGACY=n              # Disable legacy DRM (not needed, may cause conflicts)
CONFIG_DRM_FBDEV_EMULATION=y     # Framebuffer emulation via DRM

# === DRM Drivers for Virtual Machines (VirtualBox, QEMU, VMware) ===
# These drivers enable the system to run on VMs with software rendering
CONFIG_DRM_VBOXVIDEO=m          # VirtualBox graphics (for VirtualBox VMs)
CONFIG_DRM_VMWGFX=m             # VMware SVGA II graphics (for VMware VMs)
CONFIG_DRM_VIRTIO_GPU=m         # VirtIO GPU (for QEMU/KVM VMs)
CONFIG_DRM_BOCHS=m              # Bochs/QEMU simple framebuffer
CONFIG_DRM_QXL=m                # QEMU/Xen QXL graphics
CONFIG_DRM_SIMPLEDRM=y          # Simple framebuffer (generic fallback)

# Ensure kernel is built as vanilla (no vendor patches)
# This is set via kernel Makefile, but we ensure no LOCALVERSION suffix

# NVIDIA driver requires these kernel options to prevent NULL pointer dereferences:
CONFIG_MTRR=y                    # Memory Type Range Registers (required for graphics)
CONFIG_X86_PAT=y                 # Page Attribute Table (critical for GPU memory)
CONFIG_IOMMU=y                   # IOMMU support (required for GPU memory management)
CONFIG_INTEL_IOMMU=y             # Intel IOMMU (VT-d) - required for NVIDIA on Intel systems
CONFIG_INTEL_IOMMU_DEFAULT_ON=y  # Enable IOMMU by default
CONFIG_ACPI=y                    # ACPI support (required for device enumeration)
CONFIG_ACPI_TABLE_UPGRADE=y      # Allow ACPI table upgrades
CONFIG_PCI_MMCONFIG=y            # PCI MMIO configuration space access
CONFIG_EFI=y                     # EFI support (for UEFI systems)
CONFIG_EFI_STUB=y                # EFI stub support
CONFIG_EFIVAR_FS=y               # EFI variable filesystem
# AGP support (legacy, but some NVIDIA code paths may check for it)
CONFIG_AGP=y
CONFIG_AGP_INTEL=y               # Intel AGP support
# Power management (required for GPU power states)
CONFIG_PM=y                      # Power management support
CONFIG_PM_SLEEP=y                # Suspend/hibernation support

# Debug and module support (NVIDIA driver requires these for proper operation):
CONFIG_MODULES=y                 # Enable loadable module support (REQUIRED)
CONFIG_MODULE_UNLOAD=y           # Allow unloading of modules
CONFIG_MODULE_FORCE_UNLOAD=y     # Allow forced module unloading
CONFIG_DEBUG_FS=y                # Debug filesystem (NVIDIA uses /sys/kernel/debug)
CONFIG_KALLSYMS=y                # Kernel symbol table (needed for module debugging)
CONFIG_KALLSYMS_ALL=y            # Include all symbols (not just exported)
CONFIG_STACKTRACE=y              # Stack backtrace support
CONFIG_FRAME_POINTER=y            # Frame pointers (helps with debugging)
CONFIG_DEBUG_KERNEL=y            # Kernel debugging (NVIDIA driver may need this)
CONFIG_DEBUG_INFO=y              # Compile kernel with debug info
CONFIG_GENERIC_BUG=y             # Generic bug reporting
CONFIG_BUG=y                     # BUG() support

# === Networking ===
CONFIG_NET=y
CONFIG_INET=y
CONFIG_IPV6=y
CONFIG_NETFILTER=n  # No firewall complexity
CONFIG_BRIDGE=n
CONFIG_VLAN_8021Q=n  # No VLAN needed

# Intel I226-V driver
CONFIG_IGB=n  # Wrong driver
CONFIG_IGC=y  # Correct: Intel I225/I226 Ethernet

# === Storage ===
CONFIG_NVME_CORE=y
CONFIG_BLK_DEV_NVME=y
CONFIG_ATA=y
CONFIG_SATA_AHCI=y  # For SATA disks

# === Filesystems ===
CONFIG_EXT4_FS=y
CONFIG_EXT4_FS_XATTR=y
CONFIG_EXT4_FS_SECURITY=y
CONFIG_SQUASHFS=y  # For RAM boot
CONFIG_TMPFS=y
CONFIG_DEVTMPFS=y
CONFIG_PROC_FS=y
CONFIG_SYSFS=y

# === Console Graphics (for high-res terminal) ===
CONFIG_FB=y
CONFIG_FB_VESA=y                    # Fallback before NVIDIA loads
CONFIG_FB_EFI=y                     # EFI framebuffer
CONFIG_FB_SIMPLE=y                  # Simple framebuffer
CONFIG_FRAMEBUFFER_CONSOLE=y        # Console on framebuffer
CONFIG_FRAMEBUFFER_CONSOLE_DETECT_PRIMARY=y
CONFIG_VT=y
CONFIG_VT_CONSOLE=y
CONFIG_VGA_CONSOLE=y

# NVIDIA proprietary driver provides nvidia-drm.ko for console
# which enables high-resolution console (1080p, 4K)
# Kernel cmdline: nvidia-drm.modeset=1

# === Wireless/Bluetooth ===
CONFIG_WIRELESS=n
CONFIG_CFG80211=n
CONFIG_MAC80211=n
CONFIG_BT=n
CONFIG_RFKILL=n

# === Sound ===
CONFIG_SOUND=n

# === Other Graphics (not needed with NVIDIA) ===
CONFIG_DRM_I915=n
CONFIG_DRM_AMDGPU=n
CONFIG_DRM_RADEON=n
CONFIG_DRM_NOUVEAU=n  # Use proprietary NVIDIA instead

# === USB (minimal) ===
# USB core support (required for USB devices)
CONFIG_USB=y
CONFIG_USB_SUPPORT=y
CONFIG_USB_XHCI_HCD=y              # USB 3.0 host controller (xHCI)
CONFIG_USB_EHCI_HCD=y              # USB 2.0 host controller (EHCI)
CONFIG_USB_OHCI_HCD=y              # USB 1.1 host controller (OHCI)
CONFIG_USB_UHCI_HCD=y              # USB 1.1 host controller (UHCI - Intel)
CONFIG_USB_PCI=y                   # USB PCI support

# USB serial support (for USB-to-serial adapters to connect to FPGA)
CONFIG_USB_SERIAL=y
CONFIG_USB_SERIAL_GENERIC=y        # Generic USB serial driver
CONFIG_USB_SERIAL_SIMPLE=y         # Simple USB serial drivers
CONFIG_USB_SERIAL_FTDI_SIO=y       # FTDI FT232/FT2232/FT4232 (very common)
CONFIG_USB_SERIAL_PL2303=y         # Prolific PL2303 (very common)
CONFIG_USB_SERIAL_CH341=y          # CH341 USB-to-serial (common)
CONFIG_USB_SERIAL_CP210X=y         # Silicon Labs CP210x (common)
CONFIG_USB_SERIAL_ACM=y            # USB CDC ACM (Arduino, etc.)

# USB storage and printer disabled (not needed)
CONFIG_USB_STORAGE=n
CONFIG_USB_PRINTER=n

# USB HID (keyboard/mouse support)
CONFIG_USB_HID=y                   # Keep for keyboard
CONFIG_HID=y                        # HID core support

# === Input Subsystem (CRITICAL for SDL2 KMSDRM) ===
# SDL2's KMSDRM backend uses evdev to read input from /dev/input/event* devices
CONFIG_INPUT=y
CONFIG_INPUT_EVDEV=y           # Event device interface (REQUIRED for SDL2 KMSDRM!)
CONFIG_INPUT_MOUSEDEV=y        # Mouse device support (/dev/input/mice)
CONFIG_INPUT_KEYBOARD=y        # Keyboard support
CONFIG_INPUT_MOUSE=y           # Mouse driver
CONFIG_INPUT_LEDS=y            # LED support (Caps Lock, Num Lock, etc.)
CONFIG_INPUT_TOUCHSCREEN=n     # No touchscreen
CONFIG_INPUT_TABLET=n          # No tablet
CONFIG_INPUT_JOYSTICK=n        # No joystick
CONFIG_INPUT_MISC=n            # No misc input devices

# === Media/Camera ===
CONFIG_MEDIA_SUPPORT=n

# === Virtualization (not needed) ===
CONFIG_KVM=n
CONFIG_VHOST=n
CONFIG_VIRTIO=n

# === ARM/PowerPC/etc ===
# Already excluded by x86_64 config

# === Unused filesystems ===
CONFIG_NTFS3_FS=n
CONFIG_BTRFS_FS=n
CONFIG_XFS_FS=n
CONFIG_CIFS=n
CONFIG_NFS_FS=n
