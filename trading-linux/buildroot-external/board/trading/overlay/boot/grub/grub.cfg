set default=0
set timeout=15

# Note: Root partition is already found by EFI embedded config
# which searches by label "tradingfs" and sets $root variable
# This config is loaded via configfile after root is found

# CRITICAL: Load EFI video modules FIRST before any other video modules
# This initializes the EFI framebuffer which is required for gfxterm
insmod efi_gop
insmod efi_uga

# Load filesystem and partition modules
insmod part_gpt
insmod ext2
insmod iso9660
insmod fat

# Load font module (required for text display in gfxterm)
insmod font

# Set font path
font="($root)/boot/grub/unicode.pf2"

# Load video function (similar to working GRUB)
function load_video {
  if [ x$feature_all_video_module = xy ]; then
    insmod all_video
  else
    insmod efi_gop
    insmod efi_uga
    insmod ieee1275_fb
    insmod vbe
    insmod vga
    insmod video_bochs
    insmod video_cirrus
  fi
}

# Load font and set graphics mode (based on working GRUB)
if loadfont $font ; then
  set gfxmode=5120x1440
  set gfxpayloal=keep
  load_video
  insmod gfxterm
  insmod gfxterm_background
  insmod png
  set locale_dir=$prefix/locale
  set lang=en_AU
  insmod gettext
fi

# Set terminal output
#terminal_input console
terminal_output gfxterm

# Load other essential modules
insmod normal

set menu_color_normal=white/black
set menu_color_highlight=black/light-gray

# Load GRUB logo/background image (root is already set by EFI config)
if [ -f ($root)/boot/grub/logo.png ]; then
    background_image ($root)/boot/grub/logo.png
fi

menuentry "Trading Linux (Normal Boot)" {

        set gfxpayload=keep
     linux ($root)/boot/bzImage root=PARTUUID=$ROOT_UUID ro \
        loglevel=3 \
        preempt=full \
        isolcpus=14-23 nohz_full=14-23 rcu_nocbs=14-23 \
        intel_pstate=performance \
        mitigations=off \
        transparent_hugepage=never \
        nvidia-drm.modeset=1 nvidia-drm.fbdev=1 \
        systemd.udev.timeout=10 \
        fbcon=font:VGA8x16 \
        intel_iommu=on iommu=pt
    # No initrd - boot directly from NVMe partition for persistent storage
}

menuentry "Trading Linux (Debug Mode)" {
       set gfxpayload=keep
    linux ($root)/boot/bzImage root=PARTUUID=$ROOT_UUID rw \
        preempt=full \
        isolcpus=14-23 nohz_full=14-23 rcu_nocbs=14-23 \
        intel_pstate=performance \
        loglevel=7 \
        systemd.log_level=debug \
        systemd.udev.timeout=10 \
        fbcon=font:VGA8x16
    # No initrd - boot directly from NVMe partition for persistent storage
}

menuentry "Trading Linux (Recovery)" {
        set gfxpayload=keep
    linux ($root)/boot/bzImage root=PARTUUID=$ROOT_UUID rw single \
        preempt=full \
        systemd.unit=rescue.target \
        systemd.udev.timeout=10 \
        fbcon=font:VGA8x16
    # No initrd - boot directly from NVMe partition for persistent storage
}

menuentry "UEFI Firmware Settings" {
    fwsetup
}
